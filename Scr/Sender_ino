#include <ESP8266WiFi.h>
#include <espnow.h>
#include <Keypad.h>

// ---------------- Keypad Configuration ----------------
const byte ROWS = 4;
const byte COLS = 4;

char keys[ROWS][COLS] = {
  {'1','2','3','A'},
  {'4','5','6','B'},
  {'7','8','9','C'},
  {'*','0','#','D'}
};

// Pin mapping (must match your hardware connections)
byte rowPins[ROWS] = {D0, D1, D2, D3};  // R1->D0, R2->D1, R3->D2, R4->D3
byte colPins[COLS] = {D5, D6, D7, D8};  // C1->D5, C2->D6, C3->D7, C4->D8

Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);

// ---------------- Buzzer ----------------
#define BUZZER_PIN D4 // Sender's Keypress Feedback Buzzer

// ---------------- Password Buffer ----------------
String inputPassword = "";

// ---------------- ESP-NOW ----------------
// *** REPLACE WITH YOUR RECEIVER MAC ADDRESS (from the Receiver's Serial Monitor) ***
uint8_t receiverAddress[] = {0x84, 0x0D, 0x8E, 0x99, 0xE8, 0xA2};

void OnDataSent(uint8_t *mac_addr, uint8_t sendStatus) {
  Serial.print("Send Status: ");
  Serial.println(sendStatus == 0 ? "Success" : "Fail");
}

void setup() {
  Serial.begin(115200);

  pinMode(BUZZER_PIN, OUTPUT);
  digitalWrite(BUZZER_PIN, LOW); // Ensure buzzer is off initially

  // WiFi + ESP-NOW Setup
  WiFi.mode(WIFI_STA);
  if (esp_now_init() != 0) {
    Serial.println("Error initializing ESP-NOW");
    return;
  }

  esp_now_set_self_role(ESP_NOW_ROLE_CONTROLLER);
  esp_now_register_send_cb(OnDataSent);
  
  // Add receiver as a peer
  esp_now_add_peer(receiverAddress, ESP_NOW_ROLE_SLAVE, 1, NULL, 0);

  Serial.println("Sender ready. Enter password...");
}

void loop() {
  char key = keypad.getKey();

  if (key) {
    // Short beep feedback on key press
    digitalWrite(BUZZER_PIN, HIGH);
    delay(80);
    digitalWrite(BUZZER_PIN, LOW);

    if (key == '#') {
      // '#' is the send key
      if (inputPassword.length() > 0) {
        char msg[32];
        inputPassword.toCharArray(msg, 32);
        
        // Send the buffered password
        esp_now_send(receiverAddress, (uint8_t *)msg, strlen(msg));

        Serial.print("Password sent: ");
        Serial.println(inputPassword);
        inputPassword = ""; // Reset buffer after sending
      }
    }
    else if (key == '*') {
      // '*' is the clear key
      inputPassword = "";
      Serial.println("Password cleared");
    }
    else {
      // Append digit/letter to the password buffer
      inputPassword += key;
      Serial.print("Key pressed: ");
      Serial.println(key);
      Serial.print("Buffer: ");
      Serial.println(inputPassword);
    }
  }
}
